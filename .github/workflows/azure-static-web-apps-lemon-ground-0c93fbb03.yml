
name: Azure Static Web Apps CI/CD (remove tenant fragment & skip auto-build)

on:
  push:
    branches: [ main, master ]

jobs:
  build_and_deploy_job:
    runs-on: ubuntu-latest
    name: Build and Deploy (pre-patch + post-patch + runtime fix)

    steps:
      - uses: actions/checkout@v3
        with:
          submodules: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # üîß Pre-build patch: remove ALL 'go' tenant-hint variants in source (static & dynamic)
      - name: Pre-build: scrub repo source for 'go' tenant hints
        run: |
          echo "Scanning source for bad tenant hints..."
          grep -R --line-number -E "#@Go|#%40Go|tenant=go|tid=go" . || true

          # Replace fragment forms
          find . -type f \( -name '*.ts' -o -name '*.tsx' -o -name '*.js' -o -name '*.jsx' -o -name '*.html' -o -name '*.json' \) -print0 \
            | xargs -0 sed -i -E "s|#@Go(/)?|/|g"

          find . -type f \( -name '*.ts' -o -name '*.tsx' -o -name '*.js' -o -name '*.jsx' -o -name '*.html' -o -name '*.json' \) -print0 \
            | xargs -0 sed -i -E "s|#%40Go(/)?|/|g"

          # Replace query-parameter forms
          find . -type f \( -name '*.ts' -o -name '*.tsx' -o -name '*.js' -o -name '*.jsx' -o -name '*.html' -o -name '*.json' \) -print0 \
            | xargs -0 sed -i -E "s|([?&])(tenant|tid)=go(&|$)|\1|g"

          echo "Verifying source..."
          if grep -R --line-number -E "#@Go|#%40Go|tenant=go|tid=go" .; then
            echo "‚ö†Ô∏è Some occurrences remain in non-text files (ok, we also patch bundle later)"
          else
            echo "‚úÖ Source scrubbed"
          fi

      - name: Install & Build (to ./out)
        run: |
          npm ci
          npm run build
          echo "---- contents of ./out ----"
          ls -la out || true
          test -d out || (echo "‚ùå Build did not produce ./out"; exit 1)

      # üîß Post-build patch: scrub ALL variants in built bundle
      - name: Post-build: scrub built bundle for 'go' tenant hints
        run: |
          set -e
          echo "Scanning ./out before patch..."
          grep -R --line-number -E "#@Go|#%40Go|tenant=go|tid=go" out || true

          # 1) Fully-qualified scheme + fragment
          find out -type f \( -name '*.html' -o -name '*.js' -o -name '*.json' -o -name '*.css' \) -print0 \
            | xargs -0 sed -i "s|https://portal.azure.com/#@Go/|https://portal.azure.com/|g"

          # 2) Fragment-only forms (with/without trailing slash)
          find out -type f \( -name '*.html' -o -name '*.js' -o -name '*.json' -o -name '*.css' \) -print0 \
            | xargs -0 sed -i -E "s|#@Go(/)?|/|g"

          # 3) URL-encoded '@' variants in fragments
          find out -type f \( -name '*.html' -o -name '*.js' -o -name '*.json' -o -name '*.css' \) -print0 \
            | xargs -0 sed -i -E "s|#%40Go(/)?|/|g"

          # 4) Query-parameter style tenant hints
          find out -type f \( -name '*.html' -o -name '*.js' -o -name '*.json' -o -name '*.css' \) -print0 \
            | xargs -0 sed -i -E "s|([?&])(tenant|tid)=go(&|$)|\1|g"

          echo "Verifying bundle..."
          if grep -R --line-number -E "#@Go|#%40Go|tenant=go|tid=go" out; then
            echo "‚ùå A 'go' tenant hint survived in bundle"; exit 1
          else
            echo "‚úÖ Bundle scrubbed"
          fi

      # üõ°Ô∏è Runtime safety-net: sanitize Azure Portal links at click time
      - name: Inject runtime sanitizer into index.html
        run: |
          cat > sanitizer.js <<'EOF'
          (function () {
            document.addEventListener('click', function (ev) {
              const a = ev.target && ev.target.closest ? ev.target.closest('a') : null;
              if (!a || !a.href) return;
              if (!/https:\/\/portal\.azure\.com/.test(a.href)) return;

              let href = a.href
                .replace(/#@Go\/?/gi, '/')
                .replace(/#%40Go\/?/gi, '/')
                .replace(/([?&])(tenant|tid)=go(&|$)/gi, '$1');

              if (href !== a.href) a.href = href;
            }, true);
          }());
          EOF

          if [ -f out/index.html ]; then
            sed -i '/<\/body>/i <script>'"$(sed -e 's/[&/\]/\\&/g' sanitizer.js)"'</script>' out/index.html
            echo "‚úÖ Sanitizer injected into out/index.html"
          else
            echo "‚ÑπÔ∏è out/index.html not found; skipping inline injection (framework-specific)"
          fi
          rm -f sanitizer.js

      # üöÄ Deploy the **patched** out/ as-is (no auto-build)
      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_LEMON_GROUND_0C93FBB03 }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "out"     # when skip_app_build=true, this is the build output folder
          output_location: ""     # not used with skip_app_build
          skip_app_build: true    # do not let Oryx rebuild and undo our patch
          skip_api_build: true
